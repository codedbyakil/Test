name: ğŸ“º Zee5 Auto-Update M3U

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“œ Generate zee5.m3u (jq 1.5 compatible)
        run: |
          set -euo pipefail
          echo "ğŸ“¥ Fetching Zee5 channel data..."

          JSON_URL="https://z5.pfy.workers.dev"
          JSON=$(curl -sSf \
            -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36" \
            -H "Accept: application/json" \
            -H "Referer: https://playify.pages.dev/" \
            "$JSON_URL") || { echo "âŒ Failed to fetch JSON"; exit 1; }

          if [ -z "$JSON" ] || [ "${JSON:0:1}" = "<" ]; then
            echo "âŒ Response is empty or HTML (likely error page)"
            echo "First 500 chars: $(echo "$JSON" | head -c 500)"
            exit 1
          fi

          # Start fresh M3U
          echo "#EXTM3U" > zee5.m3u

          # Transform with jq (fully compatible with jq 1.5)
          echo "$JSON" | jq -r '
            # jq 1.5-safe normalize function (no elif, no bare else in def)
            def normalize:
              if type == "array" then
                .
              else
                if type == "object" then
                  if has("channels") and (.channels | type == "array") then
                    .channels
                  else
                    if has("data") and (.data | type == "array") then
                      .data
                    else
                      if has("list") and (.list | type == "array") then
                        .list
                      else
                        # Fallback: { "1": {...}, "2": {...} } â†’ [ {...}, {...} ]
                        if (. | to_entries | all(.value | type == "object")) then
                          [.[]]
                        else
                          []
                        end
                      end
                    end
                  end
                else
                  []
                end
              end;

            normalize |
            map(select(type == "object")) |
            .[] |
            # Extract fields with fallbacks
            (.name // .title // .channel_name // "Unknown") as $name |
            (.tvg_id // .tvgId // .id // "") as $tvg_id |
            (.tvg_logo // .logo // .icon // "") as $tvg_logo |
            (.drmScheme // .drm_scheme // .drm // "") as $drmScheme |
            (.drmLicense // .license // "") as $drmLicense |
            (.cookie // .cookies // "") as $cookie |
            (.link // .url // .stream_url // .hls // .mpd // "") as $link |

            # Only output if link exists
            if ($link | length) > 0 then
              "#EXTINF:-1 " +
                (if ($tvg_id | length > 0) then "tvg-id=\"\($tvg_id)\" " else "" end) +
                "group-title=\"JioStar\" " +
                (if ($tvg_logo | length > 0) then "tvg-logo=\"\($tvg_logo)\" " else "" end) +
                ",\($name | gsub(","; "\\,"))" |
              . as $extinf |

              # ClearKey DRM (Kodi)
              (if ($drmScheme == "clearkey") and ($drmLicense | test("^[a-zA-Z0-9]+:[a-zA-Z0-9]+")) then
                "#KODIPROP:inputstream.adaptive.license_type=clearkey\n#KODIPROP:inputstream.adaptive.license_key=" + 
                ($drmLicense | split(":")[0:2] | join(":"))
              else "" end) as $drm |

              # User-Agent for VLC/MPV
              "#EXTVLCOPT:http-user-agent=plaYtv/7.1.5%20(Linux%3BAndroid%2015)%20ExoPlayerLib/2.11.6%20YGX/69.69.69.69" as $ua |

              # Cookie header (VLC/MPV)
              (if ($cookie | length > 0) then
                "#EXTHTTP:{\"cookie\":\"" + ($cookie | gsub("\""; "\\\"")) + "\"}"
              else "" end) as $cookie_line |

              # Build chunk: only non-empty lines
              [$extinf, $drm, $ua, $cookie_line, $link] | map(select(. != "")) | join("\n")
            else
              empty
            end
          ' >> zee5.m3u

          # âœ… Final validation
          LINE_COUNT=$(wc -l < zee5.m3u 2>/dev/null || echo 0)
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "âŒ zee5.m3u is empty or invalid (only header)"
            echo "ğŸ“„ Generated file:"
            cat zee5.m3u
            echo "ğŸ” Raw JSON preview (first 300 chars):"
            echo "$JSON" | head -c 300
            exit 1
          fi

          echo "âœ… zee5.m3u created successfully ($LINE_COUNT lines)"
          echo "ğŸ“º First channel block:"
          awk 'NR<=10' zee5.m3u

      - name: ğŸ’¾ Commit & Push (if changed)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add zee5.m3u

          if git diff --cached --quiet; then
            echo "â¡ï¸ No changes â€” skipping commit"
            exit 0
          fi

          git commit -m "âœ… Auto-update Zee5 M3U: $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push origin main
